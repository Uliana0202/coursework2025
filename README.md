# –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã –≤–µ–¥–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–æ–≤ —Å–æ–±—ã—Ç–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –°–£–ë–î Clickhouse

## –ü–∞–ø–∫–∞ data
### –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ—Å—Ç–æ–≤—ã—Ö –ª–æ–≥–æ–≤ —Å–æ–±—ã—Ç–∏–π (generate_data.py)
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –ª–æ–≥–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å–∏—Å—Ç–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫–∏. –°–æ–∑–¥–∞–µ—Ç CSV-—Ñ–∞–π–ª —Å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –æ –¥–µ–π—Å—Ç–≤–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ.

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (–ª–æ–≥–∏–Ω—ã, –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏, —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è)
- –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
- –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
- –ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  
#### ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
NUM_RECORDS = 3000  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
START_DATE = datetime(2000, 1, 1)  # –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞
END_DATE = datetime(2024, 12, 31)  # –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞
CSV_FILE = 'logs_data_3_000.csv'  # –ò–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
```

#### üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
–ü–æ–ª–µ         |	–¢–∏–ø	    |–û–ø–∏—Å–∞–Ω–∏–µ
-------------|----------|---------------------------------|
timestamp	   |datetime	|–í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è
login        |string	  |Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
event	       |string	  |–¢–∏–ø —Å–æ–±—ã—Ç–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'login')
subsystem	   |string	  |–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞, –≥–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–æ–±—ã—Ç–∏–µ
comment      |string	  |–¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
description  |string    |–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è

#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞:
- generate_logins() - —Å–æ–∑–¥–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö email-–∞–¥—Ä–µ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- generate_events() - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 100 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π
- generate_subsystems() - —Å–æ–∑–¥–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–¥—Å–∏—Å—Ç–µ–º —Å–∏—Å—Ç–µ–º—ã
- generate_comments() - —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Å–æ–±—ã—Ç–∏—è–º
- generate_descriptions() - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è
- random_timestamp() - —Å–æ–∑–¥–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ

#### üìä –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
```
timestamp,login,event,subsystem,comment,description
2021-05-12 14:32:45,user42@gmail.com,login_success,auth,"User user42@gmail.com performed login_success in auth","Successful completion of login"
2020-11-03 09:12:22,user17@company.org,export_complete,reporting_backend,"Action export_complete completed successfully in reporting_backend","System event: export_complete"
```

## –ü–∞–ø–∫–∞ queries_select
###  –ú–æ–¥—É–ª—å generate_select_query.py
SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —É—Å–ª–æ–≤–∏–π WHERE –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤.

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π - —Å–æ–∑–¥–∞–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è —É—Å–ª–æ–≤–∏–π (–æ—Ç –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –¥–æ –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –∞—Ç—Ä–∏–±—É—Ç–æ–≤)
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ WHERE-–∫–ª–∞—É–∑ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —É—Å–ª–æ–≤–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- –°–ª—É—á–∞–π–Ω—ã–µ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –º–µ–∂–¥—É AND/OR –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π
- –ì–∏–±–∫–∏–µ —à–∞–±–ª–æ–Ω—ã —É—Å–ª–æ–≤–∏–π - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã SQL-—É—Å–ª–æ–≤–∏–π (LIKE, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞—Ç)
- –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —Ñ–∞–π–ª queries.txt

#### ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```
attributes = {
    'timestamp': "timestamp <= '2012-11-21'",  # –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
    'login': "login LIKE 'user10%'",          # –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
    'event': "event LIKE 'session%'",         # –§–∏–ª—å—Ç—Ä –ø–æ —Å–æ–±—ã—Ç–∏—è–º
    'subsystem': "subsystem LIKE 'b%'"        # –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞–º
}
```
#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ (–æ—Ç 1 –¥–æ 4 –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ)
2. –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏:
  - –°–æ–∑–¥–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É—Å–ª–æ–≤–∏–π WHERE
  - –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã AND/OR –º–µ–∂–¥—É —É—Å–ª–æ–≤–∏—è–º–∏
  - –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π SQL-–∑–∞–ø—Ä–æ—Å
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —Ñ–∞–π–ª queries.txt
4. –í—ã–≤–æ–¥–∏—Ç –∑–∞–ø—Ä–æ—Å—ã –≤ –∫–æ–Ω—Å–æ–ª—å —Å –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π

#### üìä –ü—Ä–∏–º–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
```
-- –û–¥–∏–Ω–æ—á–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ
SELECT count(*) FROM table_name WHERE subsystem LIKE 'b%';

-- –ö–æ–º–±–∏–Ω–∞—Ü–∏—è —É—Å–ª–æ–≤–∏–π —Å AND
SELECT count(*) FROM table_name WHERE login LIKE 'user10%' AND event LIKE 'session%';
```

##  –ú–æ–¥—É–ª—å generate_select_query.py

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ —Ç–∞–±–ª–∏—Ü:
  - logs_full_scan - —Ç–∞–±–ª–∏—Ü–∞ –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
  - logs_ordered - —Ç–∞–±–ª–∏—Ü–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ—Ä—è–¥–∫–æ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
  - logs_with_indexes - —Ç–∞–±–ª–∏—Ü–∞ —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
  - logs_with_projections - —Ç–∞–±–ª–∏—Ü–∞ —Å –ø—Ä–æ–µ–∫—Ü–∏—è–º–∏
- –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞–º - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ CPU
- –î–µ—Ç–∞–ª—å–Ω—ã–π —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫:
  - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
  - –ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –±–∞–π—Ç—ã
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ü–∏–π –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
  
#### ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ClickHouse
client = Client(
    host='localhost',
    user='default',
    password='',
    database='course_db'
)

# –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã
log_tables = ['logs_full_scan', 'logs_ordered', 'logs_with_indexes', 'logs_with_projections']

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
with open('queries_select/queries_and_2.txt', 'r') as f:
    queries = [(line.strip(), f"query_{idx}") for idx, line in enumerate(f.readlines(), 1)]
```

#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:
  - –í—ã–ø–æ–ª–Ω—è–µ—Ç –Ω–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
  - –°–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ system.query_log
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Ç–∞–±–ª–∏—Ü—É test_select_query
  - –í—ã–≤–æ–¥–∏—Ç —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
3. –ü—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ CPU:
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞–µ—Ç –ø–∞—É–∑—É
  - –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø–æ–≤—Ç–æ—Ä–∞–º–∏
  - –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### üìä –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞
```
==================================================
Running benchmark for query type: query_1
Query condition: timestamp BETWEEN '2007-11-21' AND '2025-11-21'
==================================================

Executing query on logs_with_indexes_v2:
SELECT count(*) FROM logs_with_indexes_v2 WHERE timestamp BETWEEN '2007-11-21' AND '2025-11-21'
Result count: 34132

Successfully inserted query log data into test_select_query table

+------------------------------------+-------------------------------------------------------------------------------------------------+---------------------+-----------------+-------------+--------------+----------------+-------------------------------------------------------------+---------+
| Table                              | Query Text                                                                                      | Execution Time      |   Duration (ms) |   Rows Read |   Bytes Read |   Memory Usage | Projections                                                 | Views   |
+====================================+=================================================================================================+=====================+=================+=============+==============+================+=============================================================+=========+
| ['course_db.logs_with_indexes_v2'] | SELECT count(*) FROM logs_with_indexes_v2 WHERE timestamp BETWEEN '2007-11-21' AND '2025-11-21' | 2025-05-24 16:32:49 |             373 |        8193 |        32784 |          45024 | ['course_db.logs_with_indexes_v2._minmax_count_projection'] | []      |
+------------------------------------+-------------------------------------------------------------------------------------------------+---------------------+-----------------+-------------+--------------+----------------+-------------------------------------------------------------+---------+

```

## –ú–æ–¥—É–ª—å insert_queries.py
–ú–æ–¥—É–ª—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –≤—Å—Ç–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ ClickHouse.

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ 4 –º–µ—Ç–æ–¥–æ–≤ –≤—Å—Ç–∞–≤–∫–∏:
  - –û–¥–∏–Ω–æ—á–Ω—ã–µ –≤—Å—Ç–∞–≤–∫–∏ (single)
  - –ü–∞–∫–µ—Ç–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ (bulk)
  - –í—Å—Ç–∞–≤–∫–∞ —á–µ—Ä–µ–∑ –±—É—Ñ–µ—Ä–Ω—É—é —Ç–∞–±–ª–∏—Ü—É (buffer)
  - –í—Å—Ç–∞–≤–∫–∞ –≤ Native-—Ñ–æ—Ä–º–∞—Ç–µ (native)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫:
  - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
  - –°–∫–æ—Ä–æ—Å—Ç—å –≤—Å—Ç–∞–≤–∫–∏ (—Å—Ç—Ä–æ–∫/—Å–µ–∫)
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ CSV
- –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞–º —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–æ—Å—å –Ω–∞ 3000+ –∑–∞–ø–∏—Å–µ–π)
  
#### ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ClickHouse
client = Client(
    host='localhost',
    user='default',
    password='',
    database='course_db'
)

# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–µ—Ç–æ–¥—ã –≤—Å—Ç–∞–≤–∫–∏ (–º–æ–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å/–æ—Ç–∫–ª—é—á–∞—Ç—å –≤ main())
TEST_METHODS = {
    'single': insert_single,
    'bulk': insert_bulk,
    'buffer': insert_buffer,
    'native': insert_native
}
```

#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
1. –û–¥–∏–Ω–æ—á–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ (insert_single)
  - –í—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
  - –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  - –ù–∞–∏—Ö—É–¥—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
2. –ü–∞–∫–µ—Ç–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ (insert_bulk)
  - –í—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
  - –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –ø—Ä–æ—Å—Ç–æ—Ç–æ–π –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
3. –ë—É—Ñ–µ—Ä–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ (insert_buffer)
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±—É—Ñ–µ—Ä–Ω—É—é —Ç–∞–±–ª–∏—Ü—É ClickHouse
  - –î–∞–Ω–Ω—ã–µ —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –±—É—Ñ–µ—Ä, –∑–∞—Ç–µ–º —Ñ–æ–Ω–æ–≤–æ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è
  - –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–±–ª–∏—Ü
4. Native-—Ñ–æ—Ä–º–∞—Ç (insert_native)
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ClickHouse
  - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  - –¢—Ä–µ–±—É–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    
#### üìä –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
```
Loaded 3000 rows from file
Starting Native format insertion...
Native insertion completed. Time: 0.87 sec

Performance test results:
native: 0.87 sec (3448 rows/sec)

Results saved to insertion_results.csv
```

##  –ú–æ–¥—É–ª—å insert_simulator.py
C–∏–º—É–ª—è—Ç–æ—Ä –Ω–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å—Ç–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ ClickHouse —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏:
  - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–æ–≤ (100-1000 –∑–∞–ø–∏—Å–µ–π)
  - –°–ª—É—á–∞–π–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –≤—Å—Ç–∞–≤–∫–∞–º–∏ (0.1-5 —Å–µ–∫)
  - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∞
- –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
  - –ü—É–ª worker-–ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏
  - –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
  - –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ ClickHouse
- –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
  - –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞—Ö
  - –ö–æ–Ω—Ç—Ä–æ–ª—å —Ç–∞–π–º–∞—É—Ç–æ–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤—Å—Ç–∞–≤–∫–∏ (–∑–∞–ø–∏—Å–µ–π/—Å–µ–∫)
  - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Native-—Ñ–æ—Ä–º–∞—Ç–∞ ClickHouse
  
#### ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```
CONFIG = {
    'ch_config': {  # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ClickHouse
        'host': 'localhost',
        'user': 'default',
        'password': '',
        'database': 'course_db',
        'settings': {
            'max_execution_time': 30,
            'use_native_format': True  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
        }
    },
    'log_file': 'data/logs_data_3_000.csv',  # –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
    'target_table': 'logs_insert_test',      # –¶–µ–ª–µ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
    'duration_minutes': 2,                   # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∞
    'min_batch_size': 100,                   # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞
    'max_batch_size': 1000,                  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞
    'min_delay_sec': 0.1,                    # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
    'max_delay_sec': 5.0,                    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
    'workers_count': 3,                      # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ worker-–ø–æ—Ç–æ–∫–æ–≤
    'max_queue_size': 10000                  # –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á
}
```

#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
![img1](https://github.com/user-attachments/assets/a366316e-46b8-481d-bdba-f5d3c7326a16)

#### üìä –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞
```
2023-05-15 14:30:22,123 - INFO - Starting log simulation...
2023-05-15 14:30:23,456 - INFO - Inserted 342 logs in 0.45s (760.0 logs/sec)
2023-05-15 14:30:25,789 - WARNING - CPU overload detected, retrying in 5 seconds
2023-05-15 14:31:22,123 - INFO - Simulation completed
```

##  –ü–∞–ø–∫–∞ skripts
### –ú–æ–¥—É–ª—å select_optimization.sql
SQL-—Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü ClickHouse —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –ø–æ–¥—Ö–æ–¥–∞–º–∏ –∫ —É—Å–∫–æ—Ä–µ–Ω–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤.

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- 4 —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π —Å—Ö–µ–º–µ:
  - logs_full_scan - –±–∞–∑–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
  - logs_ordered - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
  - logs_with_indexes - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≥—Ä–∞–Ω—É–ª
  - logs_with_projections - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ü–∏–π
  - logs_partitioned - –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ —É—Å–∫–æ—Ä–µ–Ω–∏—è ClickHouse:
  - –ü–µ—Ä–≤–∏—á–Ω—ã–µ –∫–ª—é—á–∏ (ORDER BY)
  - –ò–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–ø—É—Å–∫–∞ (Bloom Filter)
  - –ü—Ä–æ–µ–∫—Ü–∏–∏ (Projections)
  - –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  - 
#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
1. logs_full_scan
```
CREATE TABLE logs_full_scan (
    ...
) ENGINE = MergeTree()
ORDER BY tuple();  -- –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
```
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

2. logs_ordered
```
CREATE TABLE logs_ordered (
    ...
) ENGINE = MergeTree()
ORDER BY (timestamp, login, event, subsystem);
```
–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:
- –£–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º –ø–æ–ª—è–º
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —ç—Ç–∏–º –ø–æ–ª—è–º

3. logs_with_indexes
```
CREATE TABLE logs_with_indexes (
    ...
) ENGINE = MergeTree()
ORDER BY (timestamp)
SETTINGS index_granularity = 8192;

-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ Bloom Filter
ALTER TABLE logs_with_indexes
    ADD INDEX login_index login TYPE bloom_filter GRANULARITY 4;
```
–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:
- –ò–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–ø—É—Å–∫–∞ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –∏–Ω–¥–µ–∫—Å–æ–≤

4. logs_with_projections
```
CREATE TABLE logs_with_projections (
    ...
) ENGINE = MergeTree()
ORDER BY (timestamp)
SETTINGS allow_experimental_projection_optimization = 1;

-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ü–∏–∏
ALTER TABLE logs_with_projections
ADD PROJECTION login_projection (
    SELECT * ORDER BY (login, timestamp)
);
```
–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–æ–º

5. logs_partitioned
```
CREATE TABLE logs_partitioned (
    ...
) ENGINE = MergeTree()
PARTITION BY toYear(timestamp) * 10 + (toMonth(timestamp) > 6)
ORDER BY (login, event, subsystem);
```
–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:
- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –ø–æ–ª—É–≥–æ–¥–∏—è–º
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

###  –ú–æ–¥—É–ª—å test_select.sql
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞ —Ç–∞–±–ª–∏—Ü—ã —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ ClickHouse.

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è:
  - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
  - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ü–∏–π –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
- –ì–æ—Ç–æ–≤—ã–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:
  - –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
  - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ì–∏–±–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø–∞–º –∑–∞–ø—Ä–æ—Å–æ–≤
  
#### üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã test_select_query
–ü–æ–ª–µ	       | –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö|	–û–ø–∏—Å–∞–Ω–∏–µ
-------------|----------|---------------------------------|
tables	|Array(String)	|–°–ø–∏—Å–æ–∫ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
query	|String	|–¢–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
event_time	|DateTime |	–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
query_duration_ms	|UInt64	|–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–º—Å)
read_rows	|UInt64|	–ü—Ä–æ—á–∏—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫
read_bytes	|UInt64|	–ü—Ä–æ—á–∏—Ç–∞–Ω–æ –±–∞–π—Ç
memory_usage	|UInt64|	–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –ø–∞–º—è—Ç–∏ (–±–∞–π—Ç)
projections	|Array(String)|	–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ü–∏–∏
views	|Array(String)|	–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è

#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
–ü—Ä–∏–º–µ—Ä—ã –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º —Ç–∞–±–ª–∏—Ü–∞–º:
```
SELECT 
    tables,
    sum(query_duration_ms) AS total_duration_ms,
    sum(read_rows) AS total_read_rows,
    sum(read_bytes) AS total_read_bytes,
    sum(memory_usage) AS total_memory_usage,
    count() AS query_count
FROM test_select_query
GROUP BY tables
ORDER BY total_duration_ms;
```

–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É –∑–∞–ø—Ä–æ—Å–æ–≤:
```
SELECT 
    tables,
    sum(query_duration_ms) AS total_duration_ms,
    sum(read_rows) AS total_read_rows,
    sum(read_bytes) AS total_read_bytes,
    sum(memory_usage) AS total_memory_usage,
    count() AS query_count
FROM test_select_query
WHERE 
    query NOT LIKE '%login%' AND
    query NOT LIKE '%subsystem%'
GROUP BY tables
ORDER BY total_duration_ms;
```
#### üìä –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
![image](https://github.com/user-attachments/assets/8ef7b53e-bc7e-40b1-a2b5-457cddc1212f)

###  –ú–æ–¥—É–ª—å test_view.sql
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–∞—Ö —Ç–∞–±–ª–∏—Ü –≤ ClickHouse.

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ 5 —Ç–∏–ø–∞—Ö —Ç–∞–±–ª–∏—Ü:
    - logs_full_scan (–±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π)
    - logs_ordered (—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π)
    - logs_with_indexes (—Å –∏–Ω–¥–µ–∫—Å–∞–º–∏)
    - logs_with_projections (—Å –ø—Ä–æ–µ–∫—Ü–∏—è–º–∏)
    - logs_partitioned (—Å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü—É test_view
- –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ system.query_log
  
#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
1. –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ failed_events_mv
```
CREATE MATERIALIZED VIEW failed_events_mv
ENGINE = MergeTree()
ORDER BY (timestamp, login)
POPULATE 
AS
SELECT 
    timestamp,
    login,
    event,
    subsystem,
    comment
FROM logs_ordered
WHERE event LIKE '%_failed';
```
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –•—Ä–∞–Ω–µ–Ω–∏–µ –∏ –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–æ–±—ã—Ç–∏—è–º —Å –æ—à–∏–±–∫–∞–º–∏

2. –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ test_view
```
CREATE TABLE test_view (
    tables Array(String),
    query String,
    event_time DateTime,
    query_duration_ms UInt64,
    read_rows UInt64,
    read_bytes UInt64,
    memory_usage UInt64,
    projections Array(String),
    views Array(String)
) ENGINE = MergeTree
ORDER BY event_time;
```

3. –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```
-- –î–ª—è –∫–∞–∂–¥–æ–π —Ç–µ—Å—Ç–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã
SELECT 
    timestamp,
    login,
    event,
    subsystem,
    comment
FROM logs_ordered  -- –∏–ª–∏ logs_full_scan, logs_with_indexes –∏ —Ç.–¥.
WHERE event LIKE '%_failed'
ORDER BY timestamp DESC;
```

#### üìä –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
![image](https://github.com/user-attachments/assets/3fcc1ecd-4037-4ea1-a4a2-b8a65e303c96)

###  –ú–æ–¥—É–ª—å test_partitioned.sql
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –≤ ClickHouse –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ 5 —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:
  - logs_full_scan - –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
  - logs_ordered - —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ timestamp
  - logs_with_indexes - —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –≥—Ä–∞–Ω—É–ª
  - logs_with_projections - —Å –ø—Ä–æ–µ–∫—Ü–∏—è–º–∏
  - logs_partitioned - —Å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- –§–æ–∫—É—Å –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç
- –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ —Ç–∞–±–ª–∏—Ü—É test_partitioned
- –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
  
#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
1. –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ test_partitioned
```
CREATE TABLE test_partitioned (
    tables Array(String),
    query String,
    event_time DateTime,
    query_duration_ms UInt64,
    read_rows UInt64,
    read_bytes UInt64,
    memory_usage UInt64,
    projections Array(String),
    views Array(String)
ENGINE = MergeTree
ORDER BY event_time
SETTINGS index_granularity = 8192;
```
2. –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–æ–º
```
SELECT 
    timestamp,
    login,
    event,
    subsystem,
    comment
FROM logs_partitioned  -- –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Ç–∞–±–ª–∏—Ü—ã
WHERE timestamp BETWEEN '2013-01-16 20:19:58' AND '2014-04-16 20:19:58'
ORDER BY timestamp DESC;
```

3. –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
```
INSERT INTO test_partitioned
SELECT 
    tables,
    query,
    event_time,
    query_duration_ms,
    read_rows,
    read_bytes,
    memory_usage,
    projections,
    views 
FROM system.query_log
WHERE query_duration_ms > 0
    AND query LIKE 'SELECT %'
```

4. –ü—Ä–∏–º–µ—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

```
SELECT 
    tables,
    avg(query_duration_ms) AS avg_time_ms,
    avg(read_rows) AS avg_rows_read,
    avg(read_bytes) AS avg_bytes_read
FROM test_partitioned
GROUP BY tables
ORDER BY avg_time_ms;
```

#### üìä –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
![image](https://github.com/user-attachments/assets/b331a74c-fe48-4960-9789-30d0170e2f27)



###  –ú–æ–¥—É–ª—å test_insert.sql
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –≤—Å—Ç–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ ClickHouse, –≤–∫–ª—é—á–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±—É—Ñ–µ—Ä–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü.

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã logs_insert_test —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
  - LowCardinality –¥–ª—è —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –ø–æ–ª–µ–π —Å –º–∞–ª—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
  - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º –ø–æ–ª—è–º (timestamp, login, event, subsystem)
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±—É—Ñ–µ—Ä–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã logs_buffer —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
  - –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º –¥–∞–Ω–Ω—ã—Ö
  - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–æ—Ä–æ–≥–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å—Ç—Ä–æ–∫ –∏ –æ–±—ä–µ–º—É –¥–∞–Ω–Ω—ã—Ö
-–ü—Ä–∏–º–µ—Ä—ã –≤—Å—Ç–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
–û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ logs_insert_test
```
CREATE TABLE logs_insert_test (
    timestamp DateTime,
    login LowCardinality(String),
    event LowCardinality(String),
    subsystem LowCardinality(String),
    comment String,
    description String
) ENGINE = MergeTree()
ORDER BY (timestamp, login, event, subsystem);
```
–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- LowCardinality –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–Ω–∞—á–µ–Ω–∏–π
- –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π ORDER BY –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ç–∏–ø–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

–ë—É—Ñ–µ—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ logs_buffer
```
CREATE TABLE logs_buffer AS logs_insert_test
ENGINE = Buffer(
    'default', 
    'logs_insert_test',
    1,       -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏
    5,       -- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (—Å–µ–∫)
    10,      -- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (—Å–µ–∫)
    100,     -- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
    10000,   -- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
    10000,   -- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–±–∞–π—Ç)
    100000   -- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–±–∞–π—Ç)
);
```
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –≤—Å—Ç–∞–≤–æ–∫ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä

###  –ú–æ–¥—É–ª—å update_optimization_projection.sql
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø—Ä–æ–µ–∫—Ü–∏–π –≤ ClickHouse, –≤–∫–ª—é—á–∞—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –î–≤–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
  - –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å –ø—Ä–æ–µ–∫—Ü–∏—è–º–∏ (logs_with_projections_v2)
  - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (logs_with_projections_v3 + logs_with_projections_metadata)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π ClickHouse:
  - deduplicate_merge_projection_mode = 'rebuild'
  - allow_experimental_projection_optimization = 1
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ü–∏–π –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
1. –í–µ—Ä—Å–∏—è 2: –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –ø—Ä–æ–µ–∫—Ü–∏—è–º–∏
```
CREATE TABLE logs_with_projections_v2 (
    ...
) ENGINE = ReplacingMergeTree()
ORDER BY (timestamp)
SETTINGS 
    deduplicate_merge_projection_mode = 'rebuild',
    index_granularity = 8192;

-- –ü—Ä–æ–µ–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ login
ALTER TABLE logs_with_projections_v2
ADD PROJECTION login_projection_v2 (
    SELECT * ORDER BY (login, timestamp)
);
```
–£–ª—É—á—à–µ–Ω–∏—è:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ReplacingMergeTree –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ü–∏–π –ø—Ä–∏ —Å–ª–∏—è–Ω–∏–∏

2. –í–µ—Ä—Å–∏—è 3: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
```
-- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ)
CREATE TABLE logs_with_projections_v3 (
    log_id UUID DEFAULT generateUUIDv4(),
    timestamp DateTime,
    login LowCardinality(String),
    event LowCardinality(String),
    subsystem LowCardinality(String),
    PROJECTION login_projection (
        SELECT * ORDER BY (login, timestamp)
    )
) ENGINE = MergeTree()
ORDER BY (timestamp);

-- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–∏–∑–º–µ–Ω—è–µ–º—ã–µ)
CREATE TABLE logs_with_projections_metadata (
    log_id UUID,
    comment String,
    description String
) ENGINE = ReplacingMergeTree()
ORDER BY (log_id);
```
–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —á–∞—Å—Ç–æ –∏ —Ä–µ–¥–∫–æ –∏–∑–º–µ–Ω—è–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ü–∏–π –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
```
-- –ü–µ—Ä–µ–Ω–æ—Å –≤ —É–ª—É—á—à–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
INSERT INTO logs_with_projections_v2 
SELECT * FROM logs_with_projections;

-- –ü–µ—Ä–µ–Ω–æ—Å –≤ —Ä–∞–∑–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
INSERT INTO logs_with_projections_v3 (...)
SELECT ... FROM logs_with_projections;

INSERT INTO logs_with_projections_metadata
SELECT ... FROM logs_with_projections
JOIN logs_with_projections_v3 ...;
```


###  –ú–æ–¥—É–ª—å update_optimization_indexed.sql
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –≤ ClickHouse, –≤–∫–ª—é—á–∞—è —É–ª—É—á—à–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –î–≤–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
  - –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ (logs_with_indexes_v2)
  - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (logs_with_indexes_v3 + logs_with_indexes_metadata)
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–ø—É—Å–∫–∞–Ω–∏—è:
  - Bloom Filter —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–π –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç—å—é
  - –ü–æ–ª–Ω–∞—è –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ ReplacingMergeTree

#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
1. –í–µ—Ä—Å–∏—è 2: –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
```
CREATE TABLE logs_with_indexes_v2 (
    ...
) ENGINE = ReplacingMergeTree()
ORDER BY (timestamp)
SETTINGS index_granularity = 8192;

-- –ò–Ω–¥–µ–∫—Å—ã Bloom Filter
ALTER TABLE logs_with_indexes_v2
    ADD INDEX login_index_v2 login TYPE bloom_filter GRANULARITY 4;
```
–£–ª—É—á—à–µ–Ω–∏—è:
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ Bloom Filter –∏–Ω–¥–µ–∫—Å—ã (–≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç—å 4)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

2. –í–µ—Ä—Å–∏—è 3: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
```
-- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
CREATE TABLE logs_with_indexes_v3 (
    log_id UUID,
    timestamp DateTime,
    login LowCardinality(String),
    event LowCardinality(String),
    subsystem LowCardinality(String)
) ENGINE = MergeTree()
ORDER BY (timestamp);

-- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
CREATE TABLE logs_with_indexes_metadata (
    log_id UUID,
    comment String,
    description String
) ENGINE = ReplacingMergeTree()
ORDER BY (log_id);
```
–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —á–∞—Å—Ç–æ –∏ —Ä–µ–¥–∫–æ –∏–∑–º–µ–Ω—è–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤
- –ë–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
```
-- –ü–µ—Ä–µ–Ω–æ—Å –≤ —É–ª—É—á—à–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
INSERT INTO logs_with_indexes_v2 
SELECT * FROM logs_with_indexes;

-- –ü–µ—Ä–µ–Ω–æ—Å –≤ —Ä–∞–∑–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
INSERT INTO logs_with_indexes_v3 (...)
SELECT ... FROM logs_with_indexes;

INSERT INTO logs_with_indexes_metadata
SELECT ... FROM logs_with_indexes
JOIN logs_with_indexes_v3 ...;
```

###  –ú–æ–¥—É–ª—å test_update.sql
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π UPDATE –≤ ClickHouse –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–∞—Ö —Ç–∞–±–ª–∏—Ü —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º —Å–±–æ—Ä–æ–º –º–µ—Ç—Ä–∏–∫.

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ UPDATE –Ω–∞ 6 —Ç–∏–ø–∞—Ö —Ç–∞–±–ª–∏—Ü:
  - –ë–∞–∑–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã (logs_with_indexes, logs_with_projections)
  - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ (_v2)
  - –†–∞–∑–¥–µ–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (_v3 + _metadata)
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–µ
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –ø–æ–¥—Å–∏—Å—Ç–µ–º–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫:
  - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
  - –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
–ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
```
-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
ALTER TABLE logs_with_indexes 
UPDATE comment = 'two tee to two two'
WHERE subsystem = '2000-07-05 08:27:55';

-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ä–∞–∑–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ (—Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
ALTER TABLE logs_with_indexes_metadata 
UPDATE comment = 'two tee to two two'
WHERE log_id IN (SELECT log_id FROM logs_with_indexes_v3 WHERE timestamp = '2000-07-05 08:27:55');
```
–°–±–æ—Ä –º–µ—Ç—Ä–∏–∫
```
-- –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ UPDATE
INSERT INTO test_update
SELECT * FROM system.query_log
WHERE query_duration_ms > 0
AND query LIKE 'ALTER TABLE %';

-- –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ OPTIMIZE
INSERT INTO test_update
SELECT * FROM system.query_log
WHERE query_duration_ms > 0
AND query LIKE 'OPTIMIZE TABLE %';
```

–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
```
SELECT 
    tables,
    avg(query_duration_ms) AS avg_update_time,
    avg(read_rows) AS avg_rows_read,
    avg(memory_usage) AS avg_memory
FROM test_update
WHERE query LIKE 'ALTER TABLE%'
GROUP BY tables
ORDER BY avg_update_time;
```

###  –ú–æ–¥—É–ª—å update_optimization_projection.sql

#### üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏


#### üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è


